---
sidebar: sidebar 
permalink: use/failover.html 
keywords: disaster recovery, bluexp disaster recovery, failover, replicate, fail over, vmware, vcenter 
summary: NetApp Disaster Recovery是一种基于云的灾难恢复服务，可自动执行灾难恢复工作流程。 
---
= 使用NetApp Disaster Recovery将应用程序故障转移到远程站点
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/use/


[role="lead"]
如果发生灾难，请将您的主要本地 VMware 站点故障转移到另一个本地 VMware 站点或 AWS 上的 VMware Cloud。您可以测试故障转移过程以确保在需要时能够成功。

*所需的NetApp Console角色* 组织管理员、文件夹或项目管理员、灾难恢复管理员或灾难恢复故障转移管理员角色。

link:https://docs.netapp.com/us-en/console-setup-admin/reference-iam-disaster-rec-roles.html["了解NetApp Disaster Recovery中的用户角色和权限"]。https://docs.netapp.com/us-en/console-setup-admin/reference-iam-predefined-roles.html["了解所有服务的NetApp Console访问角色"^]。

*关于此任务*

在故障转移期间，灾难恢复默认使用最新的SnapMirror快照副本，但您可以从某个时间点快照中选择特定的快照（根据SnapMirror的保留策略）。如果最新副本遭到破坏（例如在勒索软件攻击期间），请使用时间点选项。

此过程会有所不同，具体取决于生产站点是否健康以及您是否由于关键基础设施故障以外的原因执行到灾难恢复站点的故障转移：

* 发生严重生产站点故障，导致无法访问源 vCenter 或ONTAP集群： NetApp Disaster Recovery允许您选择任何可用的快照进行恢复。
* 生产环境健康：您可以“立即拍摄快照”或选择之前创建的快照。


此过程会中断复制关系，将 vCenter 源虚拟机置于脱机状态，将卷注册为灾难恢复 vCenter 中的数据存储区，使用计划中的故障转移规则重新启动受保护的虚拟机，并在目标站点上启用读/写功能。



== 测试故障转移过程

在开始故障转移之前，您可以测试该过程。测试不会使虚拟机脱机。

在故障转移测试期间，灾难恢复功能会临时创建虚拟机。灾难恢复将支持FlexClone卷的临时数据存储映射到 ESXi 主机。

此过程不会占用本地ONTAP存储或 AWS 中NetApp ONTAP存储的 FSx 的额外物理容量。原始源卷不会被修改，即使在灾难恢复期间，副本作业也可以继续进行。

完成测试后，您应该使用*清理测试*选项重置虚拟机。虽然建议这样做，但这不是必需的。

测试故障转移操作不会影响生产工作负载、测试站点上使用的SnapMirror关系以及必须继续正常运行的受保护工作负载。

对于测试故障转移，灾难恢复执行以下操作：

* 对目标集群和SnapMirror关系执行预检查。
* 从选定的快照为目标站点ONTAP集群上的每个受保护的ONTAP卷创建一个新的FlexClone卷。
* 如果任何数据存储都是 VMFS，则创建一个 iGroup 并将其映射到每个 LUN。
* 将目标虚拟机在 vCenter 中注册为新的数据存储区。
* 根据资源组页面中捕获的启动顺序启动目标虚拟机。
* 取消停顿虚拟机中任何被标记为“应用程序一致”的受支持的数据库应用程序。
* 如果源 vCenter 和ONTAP集群仍处于活动状态，请创建反向SnapMirror关系，以将故障转移状态下的任何更改复制回原始源站点。


.步骤
. 登录 https://console.netapp.com/["NetApp Console"^]。
. 从NetApp Console左侧导航中，选择 *保护* > *灾难恢复*。
. 从NetApp Disaster Recovery菜单中，选择 *复制计划*。
. 选择复制计划。
. 在右侧，选择“操作”选项image:../use/icon-horizontal-dots.png["NetApp Disaster Recovery服务中的操作菜单图标"]并选择*测试故障转移*。
. 在测试故障转移页面中，输入“测试故障转移”并选择*测试故障转移*。
. 测试完成后，清理测试环境。




== 故障转移测试后清理测试环境

故障转移测试完成后，您应该清理测试环境。此过程将从测试位置、FlexClone 和临时数据存储区中删除临时虚拟机。

.步骤
. 从NetApp Disaster Recovery菜单中，选择 *复制计划*。
. 选择复制计划。
. 在右侧，选择“操作”选项 image:../use/icon-horizontal-dots.png["NetApp Disaster Recovery服务中的操作菜单图标"] 然后*清理故障转移测试*。
. 在“测试故障转移”页面中，输入“清理故障转移”，然后选择“清理故障转移测试”。




== 将源站点故障转移到灾难恢复站点

如果发生灾难，您可以根据需要将主要本地 VMware 站点故障转移到另一个本地 VMware 站点或使用 FSx for NetApp ONTAP 的AWS 上的 VMware Cloud。

故障转移过程涉及以下操作：

* 灾难恢复对目标集群和SnapMirror关系执行预检查。
* 如果您选择了最新的快照，则会执行SnapMirror更新以复制最新的更改。
* 源虚拟机已关闭。
* SnapMirror关系已中断，目标卷变为读/写。
* 根据快照的选择，活动文件系统将恢复到指定的快照（最新或选定）。
* 根据复制计划中捕获的信息创建数据存储并将其安装到 VMware 或 VMC 集群或主机。如果任何数据存储都是 VMFS，则创建一个 iGroup 并将其映射到每个 LUN。
* 目标虚拟机在 vCenter 中注册为新的数据存储区。
* 目标虚拟机根据资源组页面中捕获的启动顺序启动。
* 如果源 vCenter 仍处于活动状态，请关闭所有正在进行故障转移的源端虚拟机。
* 取消停顿虚拟机中任何被标记为“应用程序一致”的受支持的数据库应用程序。
* 如果源 vCenter 和ONTAP集群仍处于活动状态，请创建反向SnapMirror关系，以便在故障转移状态下将任何更改复制回原始源站点。  SnapMirror关系从目标虚拟机到源虚拟机是相反的。



NOTE: 对于基于数据存储的复制计划，如果您已添加并发现了任何虚拟机，但未提供映射详细信息，则这些虚拟机将包含在故障转移中。故障转移失败后，作业中会发出通知。您必须提供映射详细信息才能成功完成故障转移。


TIP: 故障转移启动后，您可以在灾难恢复站点的 vCenter 中看到恢复的虚拟机（虚拟机、网络和数据存储）。默认情况下，虚拟机会恢复到 Workload 文件夹。

.步骤
. 从NetApp Disaster Recovery菜单中，选择 *复制计划*。
. 选择复制计划。
. 在右侧，选择“操作”选项image:../use/icon-horizontal-dots.png["NetApp Disaster Recovery服务中的操作菜单图标"]并选择*故障转移*。
+
image:dr-plan-failover3.png["故障转移页面"]

. 在故障转移页面中，您可以立即创建一个新的快照，或者选择一个现有的快照作为数据存储的恢复基础。默认值为最新版本。
+
在发生故障转移之前，将拍摄当前源的快照并将其复制到当前目标。

. 或者，如果您希望在检测到通常会阻止故障转移发生的错误时仍进行故障转移，请选择“*强制故障转移*”。
. 或者，如果您希望服务在复制计划故障转移后不自动创建反向SnapMirror保护关系，请选择“*跳过保护*”。如果您希望在NetApp Disaster Recovery中将恢复的站点恢复在线之前对其执行其他操作，这将非常有用。
+

TIP: 您可以通过从复制计划操作菜单中选择*保护资源*来建立反向保护。这会尝试为计划中的每个卷创建反向复制关系。您可以重复运行此作业，直到恢复保护。当保护恢复后，您可以按照通常的方式启动故障恢复。

. 在框中输入“故障转移”。
. 选择*故障转移*。
. 要检查进度，请在菜单中选择*作业监控*。

